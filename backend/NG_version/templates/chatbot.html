<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot Interface</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+1:wght@100..900&display=swap" rel="stylesheet">
    <style>
        /* General styles */
        body {
            font-family: 'M PLUS 1', sans-serif;
            background-color: white; /* Set the body background to white */
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            color: black; /* Set default text color to black */
        }

        /* Chat container */
        .chat-container {
            width: 900px;
            height: 80vh;
            background-color: #5ef3f3; /* Background color of the chat container */
            border-radius: 10px;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            color: black; /* Set text color inside chat container to black */
        }

        /* Message area styling */
        .message-area {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 10px;
            border-radius: 10px;
            background-color: #f9f9f9; /* Light background for the message area */
        }

        /* Message bubble */
        .message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 20px;
            max-width: 75%;
            word-wrap: break-word;
            box-shadow: 0px 2px 6px rgba(0, 0, 0, 0.1);
        }

        /* User message styling */
        .message.user {
            background-color: white; /* User messages will have a white background */
            color: black; /* Text color for user messages */
            margin-left: auto;
            text-align: right;
            border-radius: 20px 20px 0 20px; /* Round top-right and bottom-right corners */
        }

        /* Bot message styling */
        .message.bot {
            background-color: white; /* Bot messages will also have a white background */
            color: black; /* Text color for bot messages */
            border-radius: 20px 20px 20px 0; /* Round top-left and bottom-left corners */
        }

        /* Input area */
        .input-area {
            display: flex;
            align-items: flex-start; /* Align items to start */
            gap: 10px;
        }

        textarea {
            flex-grow: 1; /* Makes it flexible in the input area */
            padding: 10px; /* Same padding as input */
            border: none; /* No border */
            border-radius: 20px; /* Same border radius as input */
            font-size: 16px; /* Same font size */
            color: black; /* Text color */
            background-color: #f1f1f1; /* Light background for input */
            resize: none; /* Prevent manual resizing */
            overflow: hidden; /* Hide overflow */
            max-height: 120px; /* Set a maximum height */
            line-height: 1.5; /* Control the line height for better spacing */
            transition: height 0.2s ease; /* Smooth transition for height change */
        }

        button {
            padding: 10px 20px;
            background-color: black; /* Dark Slate Gray button color */
            color: white; /* Button text color */
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 16px;
        }
        
        button:hover {
            background-color: #1C3131; /* Darker version of Dark Slate Gray on hover */
        }

        strong {
            font-weight: bold;
        }

        em {
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="message-area" id="chat-box"></div>
        <div class="input-area">
            <textarea id="user-input" rows="1" placeholder="Type your message here..." style="resize: none;"></textarea>
            <button id="send-button">Send</button>
        </div>
    </div>

    <script>
        const chatBox = document.getElementById("chat-box");
        const userInput = document.getElementById("user-input");
        const sendButton = document.getElementById("send-button");

        function formatMessage(message) {
            // Format bold and italic text using asterisks
            message = message.replace(/\*\*\*(.*?)\*\*\*/g, '<strong><em>$1</em></strong>'); // Bold Italics
            message = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); // Bold
            message = message.replace(/\*(.*?)\*/g, '<em>$1</em>'); // Italics
            
            // Replace new lines (\n) with <br> for proper line breaks
            message = message.replace(/\n/g, '<br>');
        
            // Replace bullet points (- or *) with list items (<li> tags)
            message = message.replace(/^- (.*?)(\n|$)/gm, '<li>$1</li>');
            
            return message;
        }        

        let isUserAtBottom = true; // Tracks whether the user is at the bottom of the chat

        // Check if the user is at the bottom of the chat box
        function checkScrollPosition() {
            const chatHeight = chatBox.scrollHeight;
            const visibleHeight = chatBox.clientHeight;
            const scrollPosition = chatBox.scrollTop;

            // If the user is within 20px from the bottom, consider them at the bottom
            isUserAtBottom = chatHeight - (visibleHeight + scrollPosition) < 20;
        }

        // Auto-scroll only if the user is at the bottom
        function autoScroll() {
            if (isUserAtBottom) {
                chatBox.scrollTop = chatBox.scrollHeight; // Scroll to the bottom
            }
        }

        // Listen for scroll events to detect when the user scrolls up or down
        chatBox.addEventListener('scroll', checkScrollPosition);

        // Adjust height of textarea based on content
        function autoResizeTextarea() {
            this.style.height = 'auto'; // Reset height
            this.style.height = `${Math.min(this.scrollHeight, 120)}px`; // Set new height with max limit
        }

        // Modified typeMessage function to respect user's scroll
        function typeMessage(messageDiv, message) {
            const formattedMessage = formatMessage(message); // Format the message
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = formattedMessage;

            const elements = Array.from(tempDiv.childNodes); // Get all child nodes (text and elements)

            let currentElementIndex = 0;
            let typingIndex = 0;

            const typingSpeed = 10; // Typing speed

            function typeCharacter() {
                if (currentElementIndex < elements.length) {
                    const currentNode = elements[currentElementIndex];

                    if (currentNode.nodeType === Node.TEXT_NODE) {
                        // If it's a text node, type character by character
                        if (typingIndex < currentNode.textContent.length) {
                            messageDiv.innerHTML += currentNode.textContent.charAt(typingIndex);
                            typingIndex++;
                            setTimeout(typeCharacter, typingSpeed);
                            autoScroll(); // Only auto-scroll if the user is at the bottom
                        } else {
                            // Move to the next node when done with this one
                            currentElementIndex++;
                            typingIndex = 0;
                            typeCharacter(); // Continue typing the next node
                        }
                    } else if (currentNode.nodeType === Node.ELEMENT_NODE) {
                        // If it's an HTML element, add it directly and move on
                        messageDiv.appendChild(currentNode.cloneNode(true)); // Append the HTML element
                        currentElementIndex++;
                        typeCharacter(); // Continue typing the next node
                        autoScroll(); // Only auto-scroll if the user is at the bottom
                    }
                }
            }

            typeCharacter(); // Start typing
        }

        function appendMessage(sender, message) {
            const messageDiv = document.createElement("div");
            messageDiv.classList.add("message", sender);
            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight; // Scroll to the bottom

            if (sender === 'bot') {
                typeMessage(messageDiv, formatMessage(message)); // Use typing effect for bot
            } else {
                messageDiv.innerHTML = formatMessage(message); // Display user message directly
            }
        }

        async function sendMessage() {
            const message = userInput.value.trim(); // Trim whitespace from input
            if (!message) return; // Ignore empty messages

            appendMessage("user", message); // Append user message to chat

            const response = await fetch("/chat", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ message }),
            });

            const data = await response.json();
            appendMessage("bot", data.response); // Append bot message with typing effect

            userInput.value = ""; // Clear input box after message is sent
            autoResizeTextarea.call(userInput); // Reset the height of textarea
        }

        sendButton.addEventListener("click", sendMessage);

        userInput.addEventListener("input", autoResizeTextarea); // Adjust height on input
        userInput.addEventListener("keydown", (event) => {
            if (event.key === "Enter") {
                if (!event.shiftKey) {
                    event.preventDefault(); // Prevent default behavior of adding new line
                    sendMessage(); // Send the message when Enter is pressed
                }
                // If Shift + Enter is pressed, allow new line
            }
        });
    </script>
</body>
</html>
